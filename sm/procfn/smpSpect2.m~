function [newdata, data] = smpSpect(newdata, data)

persistent olddata;
persistent nold;
persistent count;
persistent win;

npls = size(data, 1);
nsamp = size(data, 2) * 2;

if isnan(data(1))
    nold = 0;
    count = 0;    
    olddata = nan(nsamp * npls);
    data(:) = 0;
    win = window(@hann, nsamp);
end

nwin = floor((nold + size(newdata, 1))/(nsamp * npls)-.5);

nold2 = nold + size(newdata, 1) - nwin*nsamp*npls;
olddata2 = newdata(end-nold2+1:end, :);

newdata = [olddata(1:nold, :); newdata(1:(nwin+.5)*nsamp*npls-nold, :)];
newdata = reshape(newdata, npls, size(newdata, 1)/npls)';

    
ft = ifft( [reshape(newdata(1:end-nsamp/2, :), nsamp, nwin, npls), reshape(newdata(1:end-nsamp/2, :), nsamp, nwin, npls)] ...
    .* repmat(win, [1, 2*nwin, npls]));

ft2 = permute(mean(repmat(ft(:, :, 1), [1, 1, 3]) * conj(ft), 2), [3, 1, 2]);


w = nwin/(count+nwin);
data =   w * [permute(mean(abs(ft).^2, 2),  [3, 1, 2]);  real(ft2); imag(ft2)] + (1-w) * data;
count = count+nwin;


nold = nold2;
olddata(1:nold, :) = olddata2(1:nold, :);

newdata = []; % save copying